<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ke_edu">
	
	<resultMap type="KE_EDU_TEST_NAME" id="eduNameMap">
		<result property="yyyy" 				column="yyyy"/>
		<result property="code_kind" 			column="code_kind"/>
		<result property="code_certifi" 		column="code_certifi"/>
		<result property="code_seq" 			column="code_seq"/>
		<result property="code_bran" 			column="code_bran"/>
		<result property="bran_seq" 			column="bran_seq"/>
		<result property="edutest_name" 		column="edutest_name"/>
		<result property="operation_cnt" 		column="operation_cnt"/>
		<result property="season" 				column="season"/>
		<result property="receipt_pers_cnt" 	column="receipt_pers_cnt"/>
		<result property="instrument" 			column="instrument"/>
		<result property="certifi_name" 		column="certifi_name"/>
		<result property="btext" 				column="btext" />
		<result property="operation_place" 		column="operation_place" />
		<result property="start_dt" 			column="start_dt" />
		<result property="end_dt" 				column="end_dt" />
		<result property="oper_start_dt" 		column="oper_start_dt" />
		<result property="oper_end_dt" 			column="oper_end_dt" />
		<result property="code_target" 			column="code_target" />
		<result property="new_cost" 			column="new_cost" />
		<result property="new_cost_nomem" 		column="new_cost_nomem" />	
		<result property="receipt_pers_cnt" 	column="receipt_pers_cnt" />
		<result property="oper_cnt" 			column="oper_cnt" />	
	
		<result property="edu_group"			column="edu_group" />
		<result property="outside_yn"          	column="outside_yn"		/>
		<result property="edu_marks"              column="edu_marks"        />
		<result property="finish_date"            column="finish_date"      />
		<result property="account_way"            column="account_way"      />
		<result property="finish_point"           column="finish_point"     />
		<result property="account_end_dt"         column="account_end_dt"   />
		<result property="btext2"                 column="btext2"           />
		<result property="point_manage"           column="point_manage"     />
		<result property="remark"                 column="remark"           />
		<result property="test_remark"	          column="test_remark"      />
	</resultMap>
	
	<resultMap type="KE_EDU_OPERATOR" id="operatorMap">
		<result property="edutest_name" 			column="edutest_name" />
		<result property="outside_yn" 				column="outside_yn" />
		<result property="new_cost" 				column="new_cost" />
		<result property="new_cost_nomem" 			column="new_cost_nomem" />
		<result property="oper_start_dt" 			column="oper_start_dt" />
		<result property="start_dt" 				column="start_dt" />
		<result property="oper_end_dt" 				column="oper_end_dt" />
		<result property="operation_place" 			column="operation_place" />
		<result property="oper_state" 				column="oper_state" />
		<result property="yyyy" 					column="yyyy" />
		<result property="account_way" 				column="account_way" />
		<result property="start_dt" 				column="start_dt" />
		<result property="account_end_dt" 			column="account_end_dt" />
		<result property="code_bran" 				column="code_bran" />
		<result property="detcodename" 				column="detcodename" />
		<result property="code_pay_flag" 			column="code_pay_flag" />
		<result property="payname" 					column="payname" />
		<result property="receipt_no" 				column="receipt_no" />
		<result property="operkey" 					column="operkey" />
		<result property="register" 				column="register" />
		<result property="regi_date" 				column="regi_date" />
		<result property="test_bank_name" 			column="test_bank_name"/>
		<result property="test_bank_acc" 			column="test_bank_acc"/>
		<result property="test_bank_acc_owner" 		column="test_bank_acc_owner"/>
		<result property="oper_name" 				column="oper_name"/>
		<result property="oper_lic_no" 				column="oper_lic_no"/>
		<result property="oper_comp_name1" 			column="oper_comp_name1"/>
		<result property="oper_hp" 					column="oper_hp"/>
		<result property="company_tel" 				column="company_tel"/>
		<result property="oper_email" 				column="OPER_EMAIL"/>
		<result property="oper_account" 			column="oper_account"/>
		<result property="bank_name" 				column="bank_name"/>
		<result property="deposit_due_date" 		column="deposit_due_date" />
		<result property="person_yn"				column="person_yn" />
		<result property="code_bran"				column="code_bran" />
		<result property="pers_birth"				column="pers_birth" />
		<result property="btext"                    column="btext"/>
	</resultMap>
	
	<select id="selectEduTestBranList" parameterType="hashmap" resultType="hashmap">
	SELECT
   		  B.code_bran
   		, DBO.GETCODEVALUE('034', B.CODE_BRAN) AS code_bran_txt
   	FROM EDU_TEST_NAME A
    INNER JOIN EDU_TEST B 
    	ON A.CODE_KIND = B.CODE_KIND 
    	AND A.CODE_CERTIFI = B.CODE_CERTIFI 
    	AND A.CODE_SEQ = B.CODE_SEQ
    WHERE CONVERT(int, #{today}) BETWEEN B.START_DT AND B.END_DT	
    	AND A.CODE_KIND = '5'
   	GROUP BY B.CODE_BRAN
	</select>
	
	<select id="selectEduNameList" parameterType="hashmap" resultMap="eduNameMap">
	-- selectEduNameList
	SELECT 
		  ET.YYYY
		, ET.CODE_KIND
		, ET.CODE_CERTIFI
		, ET.CODE_SEQ
		, ET.CODE_BRAN
		, ET.BRAN_SEQ 
		<!-- , ETN.EDUTEST_NAME -->
		, case
	          when ETN.code_kind = '1' then
	           convert(varchar, ET.yyyy) + '년도 ' + '제' +
	           CONVERT(varchar, ET.operation_cnt) + '회 ' + (case
	          when ET.season in (1, 2) then
	           convert(varchar, ET.season) + '학기 '
	          when ET.season = 3 then
	           '집합교육 '
	          when ET.season = 4 then
	           '온라인교육 '
	          else
	           convert(varchar, ET.season) + ' '
	        end) + ETN.edutest_name + '-' + k.detcodename when ETN.code_kind = '2' then convert(varchar, ET.yyyy) + '년도 ' + ETN.edutest_name + '-' + k.detcodename + (case
	         when isnull(ET.bran_txt,
	                     '') = '' then
	          '-' +
	          convert(varchar,
	                  isnull(ET.edu_marks,
	                         0)) + '평점'
	         else
	          '(' +
	          isnull(ET.bran_txt,
	                 '') + ')' + '-' +
	          convert(varchar,
	                  isnull(ET.edu_marks,
	                         0)) + '평점'
	       end) when ETN.code_kind = '3' then convert(varchar, ET.yyyy) + '년도 ' + ETN.edutest_name + '-' + k.detcodename + (case
	         when isnull(ET.bran_txt,
	                     '') = '' then
	          ''
	         else
	          '(' +
	          isnull(ET.bran_txt,
	                 '') + ')'
	       end) when ETN.code_kind = '4' or ETN.code_kind = '8' then convert(varchar, ET.yyyy) + '년도 ' + ETN.edutest_name + '-' + k.detcodename + '-' + CONVERT(varchar, ET.operation_cnt) + '차' when ETN.code_kind = '5' then convert(varchar, ET.yyyy) + '년도 ' + '제' + CONVERT(varchar, ET.operation_cnt) + '회 ' + (case
	         when ET.season in
	              (1, 2) then
	          convert(varchar,
	                  ET.season) +
	          '학기 '
	         when ET.season = 3 then
	          '집합교육 '
	         when ET.season = 4 then
	          '온라인교육 '
	         else
	          convert(varchar,
	                  ET.season) + ' '
	       end) + ETN.edutest_name + '-' + k.detcodename when ETN.code_kind = '6' then '제' + CONVERT(varchar, ET.operation_cnt) + '회 ' + ETN.edutest_name when ETN.code_kind = '7' then convert(varchar, ET.yyyy) + '년도 ' + ETN.edutest_name + '-' + k.detcodename + (case
	         when isnull(ET.bran_txt,
	                     '') = '' then
	          ''
	         else
	          '(' +
	          isnull(ET.bran_txt,
	                 '') + ')'
	       end) else ETN.edutest_name + '-' + isnull(ET.bran_txt, '') + '-(' + k.detcodename + ')' end EDUTEST_NAME
		, ET.OPERATION_CNT
		, ET.SEASON
		, ET.RECEIPT_PERS_CNT
		, (SELECT CC.TEMPCD1 FROM COM_CODE CC WHERE CC.GROUPCODE='034' AND CC.DETCODE = ET.CODE_BRAN) AS INSTRUMENT
		, (SELECT CC.CERTIFI_NAME FROM CERTIFI CC WHERE CC.CODE_CERTIFI = ET.CODE_CERTIFI) AS CERTIFI_NAME
		<!-- , ET.BRAN_TXT AS BTEXT -->
		, ET.operation_place
		, ET.start_dt
		, ET.end_dt
		, ET.oper_start_dt
		, ET.oper_end_dt
		, ET.code_target
		, ET.new_cost
		, ET.new_cost_nomem
		<if test="examYn != null">
		, ( 
			SELECT
				COUNT(OPER.receipt_no) 
			FROM OPERATER OPER
			WHERE ET.code_kind = OPER.code_kind 
				AND ET.code_certifi = OPER.code_certifi
				AND ET.code_seq = OPER.code_seq
				AND ET.code_bran = OPER.code_bran
				AND ET.bran_seq = OPER.bran_seq 
		) as oper_cnt
		</if>
		, ( 
            SELECT
                MAX ('Y') 
            FROM OPERATER OPER
            WHERE ET.code_kind = OPER.code_kind 
                AND ET.code_certifi = OPER.code_certifi
                AND ET.code_seq = OPER.code_seq
                AND ET.code_bran = OPER.code_bran
                AND ET.bran_seq = OPER.bran_seq
                <!-- 취소건 제외 -->
                AND OPER.OPER_STATE != '09'
                AND OPER.PERSON_YN = #{ personYn }
        ) as BTEXT
	FROM EDU_TEST_NAME ETN INNER JOIN EDU_TEST ET 
	ON 
		ETN.CODE_KIND = ET.CODE_KIND  
		AND ETN.CODE_CERTIFI = ET.CODE_CERTIFI 
		AND ETN.CODE_SEQ = ET.CODE_SEQ 
    left join com_code k on k.groupcode = '034' and k.detcode = ET.code_bran
	WHERE CONVERT(int, #{today}) BETWEEN ET.START_DT AND ET.END_DT
		AND ET.use_yn = 'y'
		<choose>
			<when test="examYn != null ">
				AND ET.CODE_KIND = '5'
			</when>
			<otherwise>
			<![CDATA[
				AND ET.CODE_KIND <> '5'
			]]>
			</otherwise>
		</choose>
		<if test='codeBran != null and codeBran != ""'>
			AND CODE_BRAN = #{codeBran}
		</if>
	ORDER BY ET.OPER_START_DT ASC
	</select>
	
	<select id="selectEduTestByEduId" parameterType="string" resultMap="eduNameMap">
	SELECT
		  a.season
		, a.yyyy
		, b.edu_group
		, a.code_bran
		, b.edutest_name
		, b.outside_yn
		, b.edu_marks
		, A.new_cost
		, a.oper_start_dt
		, a.start_dt
		, a.end_dt
		, a.oper_end_dt
		, b.finish_date
		, account_way
		, a.operation_place
		, a.code_kind
		, b.finish_point
		, b.code_kind
		, b.code_seq
		, a.code_certifi
		, a.bran_seq
		, a.account_end_dt
		, a.bran_txt as btext2
		, b.point_manage
		, dbo.getcodevalue('034', a.code_bran)as instrument
		, a.remark
		, b.remark as name_remark
		, (select c.certifi_name from certifi c where a.code_certifi = c.code_certifi) as certifi_name
		, A.new_cost_nomem
    FROM EDU_TEST A INNER JOIN EDU_TEST_NAME B 
    	ON A.CODE_KIND = B.CODE_KIND AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ
    WHERE A.CODE_KIND + A.CODE_CERTIFI + A.CODE_SEQ + A.CODE_BRAN + A.BRAN_SEQ  = #{eduId}
	</select>
	
	<select id="selectOperatorCount" parameterType="KE_EDU_OPERATOR" resultType="int">
	SELECT
		COUNT(code_kind)
	FROM OPERATER
	WHERE code_kind = #{code_kind}
		AND code_certifi = #{code_certifi}
		AND code_seq = #{ code_seq }
		AND code_bran = #{ code_bran }
		AND bran_seq = #{ bran_seq }
		AND person_yn = #{ person_yn }
		AND oper_state IN ('01','11' ) <!-- // 01.신청확인, 11 : 확정 ( 접수상태 ) -->
	</select>
	
	
	<select id="selectOperatorLimitPersCnt" parameterType="KE_EDU_OPERATOR" resultType="hashmap">
	SELECT 
		  a.receipt_pers_cnt
		, COUNT(b.receipt_no) oper_cnt
	FROM edu_test a left join operater b 
	ON b.code_kind = a.code_kind 
		AND b.code_certifi = a.code_certifi
		AND b.code_seq = a.code_seq
		AND b.code_bran = a.code_bran
		AND b.bran_seq = a.bran_seq 
	WHERE a.code_kind = #{code_kind}
		AND a.code_certifi = #{code_certifi}
		AND a.code_seq = #{ code_seq }
		AND a.code_bran = #{ code_bran }
		AND a.bran_seq = #{ bran_seq }
	GROUP BY a.receipt_pers_cnt
	</select>
	
	
	
	<!-- // 교육신청  최대값-->
	<select id="selectOperatorMaxReceiptNo" parameterType="KE_EDU_OPERATOR" resultType="string">
	SELECT 
		ISNULL(MAX(receipt_no),0) 
	FROM operater
	WHERE code_kind + code_certifi + code_seq + code_bran + bran_seq 
		= #{code_kind} + #{code_certifi} + #{ code_seq } + #{ code_bran } + #{ bran_seq }
	</select>
	
	<!-- // 교육신청 -->
	<insert id="insertOperator" parameterType="KE_EDU_OPERATOR">
	INSERT INTO operater (
		code_kind ,
		code_certifi ,
		code_seq ,
		code_bran ,
		bran_seq ,
		receipt_no ,
		oper_name ,
		oper_birth ,
		oper_lic_no ,
		oper_hp ,
		oper_email ,
		code_email_comp ,
		code_operation ,
		code_post ,
		oper_comp_name1 ,
		oper_comp_add1_1 ,
		oper_comp_add1_2 , 
		company_tel ,
		receipt_dt ,
		person_yn ,
		oper_state
	) Select
 			#{ code_kind },
			#{ code_certifi } ,
			#{ code_seq } ,
			#{ code_bran } ,
			#{ bran_seq } ,
			#{ receipt_no },
		 	a.pers_name ,
		 	a.pers_birth ,
			a.lic_no ,
			a.pers_hp ,
			a.email ,
			a.code_email_comp ,
			'1' ,
			CASE WHEN isnull(c.code_post,'') = '' then isnull(a.code_post,'') else c.code_post end code_post ,
			isnull(c.company_name,'') company_name ,
			CASE 
				WHEN isnull(c.company_add,'') != '' and c.company_add like '서울%' then '01'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '부산%' then '02'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '인천%' then '03'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '경기%' then '04'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '강원%' then '05'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '충청북도%' then '06'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '충청남도%' then '07'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '전라북도%' then '08'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '광주%' then '09'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '전라남도%' then '10'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '대구%' then '11'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '대전%' then '12'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '경상북도%' then '13'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '경상남도%' then '14'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '울산%' then '15'
				WHEN isnull(c.company_add,'') != '' and c.company_add like '제주%' then '16'
				ELSE '17' end as bran_set ,
			CASE WHEN isnull(c.company_add,'') = '' then RTRIM(a.pers_add) + ' ' + RTRIM(a.pers_add_detail) else RTRIM(c.company_add) + ' ' + RTRIM(c.company_add_detail) end comp_add ,
			CASE WHEN isnull(c.company_tel,'') = '' then isnull(a.pers_tel,'') else isnull(c.company_tel,'') end company_tel ,
    		CONVERT(VARCHAR(20), GETDATE(), 112) ,
			a.code_pers ,										
			'01' 
		FROM Person_M_TBL a
			LEFT JOIN (
					SELECT 
						z.code_pers, 
						max(z.company_name) company_name, 
						max(z.code_post) code_post, 
						max(z.company_add) company_add, 
						max(z.company_add_detail) company_add_detail, 
						max(z.company_tel) company_tel, 
						max(z.code_great) code_great, 
						max(z.code_use) code_use, 
						max(z.trust_name) trust_name
    				FROM pers_company z 
    				WHERE z.primary_flag = '1' 
    					AND z.comp_seq = (
    						SELECT MAX(comp_seq) FROM pers_company 
    						WHERE code_pers = z.code_pers 
    							AND primary_flag = '1'
    					) GROUP BY code_pers
    				) c  
    		ON a.code_pers = c.code_pers
		, id_tbl b
    	WHERE a.code_pers = b.code_pers 
    		AND a.code_pers = #{ person_yn }
	</insert>
	
	<!--  // 신청자 상태 변경 -->
	<update id="updateOperator" parameterType="KE_EDU_OPERATOR">
	UPDATE operater SET
		<if test="update_kind == 'pay'">
		  oper_account = #{oper_account}
		, bank_name = #{bank_name}
		, deposit_due_date = #{deposit_due_date}
		, code_pay_flag = #{code_pay_flag}
		</if>
		<if test="update_kind == 'cancel'">
		oper_state= '09'
		, register='system_cancel_l'
		, regi_date = getdate() 
		</if>
	WHERE code_kind + code_certifi + code_seq + code_bran + bran_seq + receipt_no = #{oper_key}
	</update>
	
	<select id="selectOperatorList" parameterType="hashmap" resultMap="operatorMap">
	SELECT
    	<!-- C.EDUTEST_NAME, -->
    	case
              when C.code_kind = '1' then
               convert(varchar, B.yyyy) + '년도 ' + '제' +
               CONVERT(varchar, B.operation_cnt) + '회 ' + (case
              when B.season in (1, 2) then
               convert(varchar, B.season) + '학기 '
              when B.season = 3 then
               '집합교육 '
              when B.season = 4 then
               '온라인교육 '
              else
               convert(varchar, B.season) + ' '
            end) + C.edutest_name + '-' + k.detcodename when C.code_kind = '2' then convert(varchar, B.yyyy) + '년도 ' + C.edutest_name + '-' + k.detcodename + (case
             when isnull(B.bran_txt,
                         '') = '' then
              '-' +
              convert(varchar,
                      isnull(B.edu_marks,
                             0)) + '평점'
             else
              '(' +
              isnull(B.bran_txt,
                     '') + ')' + '-' +
              convert(varchar,
                      isnull(B.edu_marks,
                             0)) + '평점'
           end) when C.code_kind = '3' then convert(varchar, B.yyyy) + '년도 ' + C.edutest_name + '-' + k.detcodename + (case
             when isnull(B.bran_txt,
                         '') = '' then
              ''
             else
              '(' +
              isnull(B.bran_txt,
                     '') + ')'
           end) when C.code_kind = '4' or C.code_kind = '8' then convert(varchar, B.yyyy) + '년도 ' + C.edutest_name + '-' + k.detcodename + '-' + CONVERT(varchar, B.operation_cnt) + '차' when C.code_kind = '5' then convert(varchar, B.yyyy) + '년도 ' + '제' + CONVERT(varchar, B.operation_cnt) + '회 ' + (case
             when B.season in
                  (1, 2) then
              convert(varchar,
                      B.season) +
              '학기 '
             when B.season = 3 then
              '집합교육 '
             when B.season = 4 then
              '온라인교육 '
             else
              convert(varchar,
                      B.season) + ' '
           end) + C.edutest_name + '-' + k.detcodename when C.code_kind = '6' then '제' + CONVERT(varchar, B.operation_cnt) + '회 ' + C.edutest_name when C.code_kind = '7' then convert(varchar, B.yyyy) + '년도 ' + C.edutest_name + '-' + k.detcodename + (case
             when isnull(B.bran_txt,
                         '') = '' then
              ''
             else
              '(' +
              isnull(B.bran_txt,
                     '') + ')'
           end) else C.edutest_name + '-' + isnull(B.bran_txt, '') + '-(' + k.detcodename + ')' end EDUTEST_NAME,
    	C.OUTSIDE_YN, 
    	B.NEW_COST, 
    	B.NEW_COST_NOMEM ,
    	B.OPER_START_DT, 
    	B.START_DT, 
    	B.OPER_END_DT,
   		B.OPERATION_PLACE, 
   		A.OPER_STATE, 
   		B.YYYY, 
   		B.ACCOUNT_WAY, 
   		B.START_DT, 
   		B.ACCOUNT_END_DT,
   		B.CODE_BRAN,
   		DBO.GETCODEVALUE('034', A.CODE_BRAN) AS DETCODENAME,
  		A.CODE_PAY_FLAG, 
  		DBO.GETCODEVALUE('014', A.CODE_PAY_FLAG) AS PAYNAME,
    	A.RECEIPT_NO, 
    	(A.CODE_KIND + A.CODE_CERTIFI + A.CODE_SEQ + A.CODE_BRAN + A.BRAN_SEQ) AS OPERKEY,
    	A.OPER_NAME,
		A.OPER_LIC_NO, 
		A.OPER_COMP_NAME1,
		A.OPER_HP,
		A.COMPANY_TEL,
		A.OPER_EMAIL, 
    	A.REGISTER, 
    	A.REGI_DATE,
    	B.BANK_NAME AS TEST_BANK_NAME,
    	B.BANK_ACC AS TEST_BANK_ACC,
    	B.BANK_ACC_OWNER AS TEST_BANK_ACC_OWNER,
    	A.OPER_ACCOUNT,
		A.BANK_NAME,
		A.DEPOSIT_DUE_DATE,
		A.PERSON_YN,
		A.OPER_BIRTH AS pers_birth,
		B.BRAN_TXT AS btext
    FROM OPERATER A 
    	INNER JOIN EDU_TEST B 
    	ON A.CODE_KIND = B.CODE_KIND 
    		AND A.CODE_CERTIFI = B.CODE_CERTIFI
   			AND A.CODE_SEQ = B.CODE_SEQ 
   			AND A.CODE_BRAN = B.CODE_BRAN 
   			AND A.BRAN_SEQ = B.BRAN_SEQ
  		INNER JOIN EDU_TEST_NAME C 
  		ON B.CODE_KIND = C.CODE_KIND AND B.CODE_CERTIFI = C.CODE_CERTIFI
    		AND B.CODE_SEQ = C.CODE_SEQ
        left join com_code k on k.groupcode = '034' and k.detcode = B.code_bran
   	WHERE A.person_yn = #{person_yn}
   	  AND CONVERT(VARCHAR(8), GETDATE(), 112) <![CDATA[ <=]]> B.OPER_END_DT
	    <choose>
	    	<when test=' oper_state != null and oper_state != "" '>
	    		AND (A.OPER_STATE = #{oper_state} or A.OPER_STATE=11)
	    	</when>
	    	<otherwise>
	    		<![CDATA[ 
	    		AND A.OPER_STATE <> '09'	
	    		]]>
	    	</otherwise>
	    </choose>
	    
    	<if test=' oper_key != null and oper_key != "" '>
    		AND A.CODE_KIND + A.CODE_CERTIFI + A.CODE_SEQ + A.CODE_BRAN + A.BRAN_SEQ + A.RECEIPT_NO = #{oper_key}
    	</if>
    	ORDER BY B.START_DT DESC
	</select>
	
	
	<!-- // ========== 자격시험 관련 ================= 
		- 해당학기 자격시험 신청여부 확인
	-->
	<select id="selectExamOperatorCount" parameterType="hashmap" resultType="int">
    	SELECT
    		COUNT(A.CODE_KIND)
    		<!-- // (A.CODE_KIND + A.CODE_CERTIFI + A.CODE_SEQ + CONVERT(VARCHAR(1), C.SEASON)) AS EDU_KEY -->
    	FROM OPERATER A
    	LEFT JOIN OPER_RESULT B 
    		ON A.CODE_KIND = B.CODE_KIND AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ
    			AND A.CODE_BRAN = B.CODE_BRAN AND A.BRAN_SEQ = B.BRAN_SEQ AND A.RECEIPT_NO = B.RECEIPT_NO
   		INNER JOIN EDU_TEST C 
   			ON A.CODE_KIND = C.CODE_KIND AND A.CODE_CERTIFI = C.CODE_CERTIFI AND A.CODE_SEQ = C.CODE_SEQ
   	  			AND A.CODE_BRAN = C.CODE_BRAN AND A.BRAN_SEQ = C.BRAN_SEQ
    	INNER JOIN EDU_TEST_NAME D 
    		ON C.CODE_KIND = D.CODE_KIND AND C.CODE_CERTIFI = D.CODE_CERTIFI AND C.CODE_SEQ = D.CODE_SEQ
    	WHERE A.CODE_KIND = '5'
    		AND A.person_yn = #{codePers}
    		AND A.OPER_STATE IN ('01', '11')
   			AND C.YYYY = #{curYear}
    		AND C.OPER_END_DT  > #{today}
    		AND A.CODE_KIND = #{codeKind}
    		AND A.CODE_CERTIFI = #{codeCertifi}
    		AND A.CODE_SEQ = #{codeSeq}
    		AND C.SEASON = #{season}
	</select>
	
	<!-- // 자격증 보유 현황 목록 -->
	<select id="selectPersonCertifiList" parameterType="hashmap" resultType="KE_EDU_CERTIFI">
	SELECT 
	 	  B.CODE_CERTIFI
		, A.CERTIFI_NAME
		, B.PRINT_STATE
		, B.RESULT_DT
		, MAX(CAST(B.RESULT_NO AS INTEGER)) RESULT_NO
		, MAX(B.RESULT_START_DT) RESULT_START_DT
		, MAX(B.RESULT_END_DT) RESULT_END_DT
	FROM CERTIFI A, RESULT_PRINT B  
	WHERE A.CODE_CERTIFI= B.CODE_CERTIFI
		AND B.CODE_PERS= #{codePers}
		<if test="avail != null">
			AND CONVERT(VARCHAR(8), GETDATE(), 112) BETWEEN B.RESULT_START_DT AND B.RESULT_END_DT
	        <![CDATA[
	        AND B.PRINT_STATE <> '2'
	        ]]>
        </if>
	GROUP BY B.CODE_CERTIFI, A.CERTIFI_NAME, B.PRINT_STATE, B.RESULT_DT, B.RESULT_NO 
	ORDER BY CODE_CERTIFI, RESULT_END_DT DESC
	</select>
	
	<!-- // 해당 학기 교육 이수 여부 확인 -->
	<select id="selectExamCompEduOperaterFlag" parameterType="KE_EDU_OPERATOR" resultType="string">
	SELECT
    	    TOP(1) 'Y' AS FLAG
	FROM OPERATER A
   		LEFT JOIN OPER_RESULT B ON A.CODE_KIND = B.CODE_KIND AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ
        	AND A.CODE_BRAN = B.CODE_BRAN AND A.BRAN_SEQ = B.BRAN_SEQ AND A.RECEIPT_NO = B.RECEIPT_NO 
        INNER JOIN EDU_TEST C ON A.CODE_KIND = C.CODE_KIND AND A.CODE_CERTIFI = C.CODE_CERTIFI AND A.CODE_SEQ = C.CODE_SEQ
        	 AND A.CODE_BRAN = C.CODE_BRAN AND A.BRAN_SEQ = C.BRAN_SEQ 
  	WHERE A.CODE_KIND = '1'
   		AND A.CODE_CERTIFI = #{code_certifi}
        <![CDATA[
        AND A.OPER_STATE >= '10'
        AND ISNULL(B.RESULT_STATE, '-1') >= '10'
        ]]>
         AND C.SEASON = ( 	SELECT
								SEASON
  							FROM EDU_TEST
  							WHERE (CODE_KIND + CODE_CERTIFI + CODE_SEQ + CODE_BRAN + BRAN_SEQ + CONVERT(VARCHAR(1),SEASON)) = #{edu_test_key}  )
       	AND PERSON_YN = #{code_pers}
	</select>
	
	<!-- // 석사이상 여부 확인 -->
	<select id="selectExamMasterYn" parameterType="KE_EDU_OPERATOR" resultType="string">
	select TOP(1) 
	       case when a.code_operation = '3' and c.result_state = '02'
		        then 'Y'
			    else 'N'
		    END OPERATION_YN
	from operater a
	LEFT JOIN edu_test b 
                  ON        b.code_kind = a.code_kind 
                  AND       b.code_certifi = a.code_certifi 
                  AND       b.code_seq = a.code_seq 
                  AND       b.code_bran = a.code_bran 
                  AND       b.bran_seq = a.bran_seq 
	LEFT JOIN oper_result c 
                  ON        c.code_kind = a.code_kind 
                  AND       c.code_certifi = a.code_certifi 
                  AND       c.code_seq = a.code_seq 
                  AND       c.code_bran = a.code_bran 
                  AND       c.bran_seq = a.bran_seq 
                  AND       c.receipt_no = a.receipt_no 
	
	where 1=1
	and a.PERSON_YN = #{code_pers} 
	and a.code_kind = '5'
	and a.CODE_CERTIFI = #{code_certifi}
	and b.season =  right(#{edu_test_key},1)
	order by  b.start_dt desc
	</select>
	
	<!-- // 해당 학기 시험 응시 여부 확인 사전 작업 -->
	<select id="selectMaxResultEndDt" parameterType="KE_EDU_OPERATOR" resultType="string">
	SELECT 
		TOP(1) RESULT_END_DT 
	FROM RESULT_PRINT
    WHERE CODE_PERS = #{code_pers} 
    	AND  CODE_CERTIFI = #{code_certifi} 
    	AND PRINT_STATE = '2'
    ORDER BY RESULT_END_DT DESC
	</select>
	
	
	<!-- // 해당 학기 시험 응시 여부 확인  -->
	<select id="selectExamOnceOperKey" parameterType="KE_EDU_OPERATOR"  resultType="string">
	SELECT
    	TOP(1) A.CODE_KIND + A.CODE_CERTIFI + A.CODE_SEQ + A.CODE_BRAN + A.BRAN_SEQ + A.RECEIPT_NO
	FROM OPERATER A
    	LEFT JOIN OPER_RESULT B 
    		ON A.CODE_KIND = B.CODE_KIND AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ 
    			AND A.CODE_BRAN = B.CODE_BRAN AND A.BRAN_SEQ = B.BRAN_SEQ AND A.RECEIPT_NO = B.RECEIPT_NO 
    	INNER JOIN EDU_TEST C 
    		ON A.CODE_KIND = C.CODE_KIND AND A.CODE_CERTIFI = C.CODE_CERTIFI AND A.CODE_SEQ = C.CODE_SEQ 
   	 			AND A.CODE_BRAN = C.CODE_BRAN AND A.BRAN_SEQ = C.BRAN_SEQ 
	WHERE A.CODE_KIND = '5' 
		AND A.CODE_CERTIFI = #{code_certifi}
		 <![CDATA[
		AND A.OPER_STATE >= '10'
		AND A.CODE_OPERATION >= '1'
		]]>
		<if test="result_end_dt != null">
		 <![CDATA[
		AND C.START_DT >= #{result_end_dt}
		]]>
		</if>
		<![CDATA[
		AND ISNULL(B.RESULT_STATE, '-1') < '10' 
		]]>
 		AND C.SEASON = ( 
    		SELECT SEASON FROM EDU_TEST
    		WHERE ( CODE_KIND + CODE_CERTIFI + CODE_SEQ + CODE_BRAN + BRAN_SEQ + CONVERT(VARCHAR(1),SEASON)) = #{edu_test_key} 
		)  
		
		AND PERSON_YN = #{code_pers} 
		ORDER BY C.OPER_END_DT DESC
	</select>
	
	<select id="selectExamPassFlag" parameterType="KE_EDU_OPERATOR" resultType="string">
	SELECT 
    	TOP(1) 'Y' AS FLAG
	FROM OPERATER A
    LEFT JOIN OPER_RESULT B 
    	ON A.CODE_KIND = B.CODE_KIND AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ
    	AND A.CODE_BRAN = B.CODE_BRAN AND A.BRAN_SEQ = B.BRAN_SEQ AND A.RECEIPT_NO = B.RECEIPT_NO
    INNER JOIN EDU_TEST C 
    	ON A.CODE_KIND = C.CODE_KIND AND A.CODE_CERTIFI = C.CODE_CERTIFI AND A.CODE_SEQ = C.CODE_SEQ
    		AND A.CODE_BRAN = C.CODE_BRAN AND A.BRAN_SEQ = C.BRAN_SEQ
	WHERE A.CODE_KIND = '5' 
		AND A.CODE_CERTIFI = #{code_certifi}
		<![CDATA[ 
		AND A.OPER_STATE >= '10'
		]]>
		<if test="result_end_dt != null">
		<![CDATA[ 
		AND C.START_DT >= #{result_end_dt} 
		]]>
		</if>
		<![CDATA[ 
		AND ISNULL(B.RESULT_STATE, '-1') >= '10'
		]]>
		AND C.SEASON = ( 
    		SELECT SEASON FROM EDU_TEST
    		WHERE ( CODE_KIND + CODE_CERTIFI + CODE_SEQ + CODE_BRAN + BRAN_SEQ ) = #{edu_test_key} 
		) 
		AND PERSON_YN = #{code_pers} 
		ORDER BY C.OPER_END_DT DESC
	</select>
	
	<insert id="insertExamOperator" parameterType="KE_EDU_OPERATOR">
	INSERT INTO OPERATER(
	      CODE_KIND
	    , CODE_CERTIFI
	    , CODE_SEQ
	    , CODE_BRAN
	    , BRAN_SEQ
	    , RECEIPT_NO
	    , OPER_NAME
	    , OPER_BIRTH
	    , OPER_LIC_NO
	    , OPER_HP
	    , OPER_EMAIL
	    , CODE_EMAIL_COMP
	    , CODE_OPERATION
	    , CODE_POST
	    , OPER_COMP_NAME1
	    , OPER_COMP_ADD1_1
	    , OPER_COMP_ADD1_2
	    , RECEIPT_DT
	    , CODE_PAY_FLAG
	    , BANK_NAME
	    , PERSON_YN
	    , OPER_STATE
	    , COMPANY_TEL
	    , REMITTOR
	    , DEPOSIT_DUE_DATE
	    , REFUND_ACCOUNT
	    , REFUND_ACCOUNT_OWNER
	    , REFUND_BANK
	) VALUES (
	      #{code_kind}
	    , #{code_certifi}
	    , #{code_seq} 
	    , #{code_bran}
	    , #{bran_seq}
	    , #{receipt_no} 
	    , #{oper_name}
	    , #{oper_birth}
	    , #{oper_lic_no}  
	    , #{oper_hp} 
	    , #{oper_email}
	    , #{code_email_comp}
	    , #{code_operation}
	    , #{code_post}
	    , #{oper_comp_name1}
	    , case 
	   		when #{oper_comp_add1_2} like '서울%' then '01'
     		when #{oper_comp_add1_2} like '부산%' then '02'
     		when #{oper_comp_add1_2} like '인천%' then '03'
     		when #{oper_comp_add1_2} like '경기%' then '04'
     		when #{oper_comp_add1_2} like '강원%' then '05'
     		when #{oper_comp_add1_2} like '충청북도%' then '06'
     		when #{oper_comp_add1_2} like '충청남도%' then '07'
    		when #{oper_comp_add1_2} like '전라북도%' then '08'
     		when #{oper_comp_add1_2} like '광주%' then '09'
     		when #{oper_comp_add1_2} like '전라남도%' then '10'
     		when #{oper_comp_add1_2} like '대구%' then '11'
     		when #{oper_comp_add1_2} like '대전%' then '12'
     		when #{oper_comp_add1_2} like '경상북도%' then '13'
     		when #{oper_comp_add1_2} like '경상남도%' then '14'
     		when #{oper_comp_add1_2} like '울산%' then '15'
     		when #{oper_comp_add1_2} like '제주%' then '16'
    	 	else '17' 
	      end
	    , #{oper_comp_add1_2}
	    , CONVERT(VARCHAR(8), GETDATE(), 112)
	    , '10'
	    , #{bank_nm}
	    , #{code_pers} 
	    , '01'
	    , #{company_tel}
	    , #{remittor}
	    , #{deposit_due_date}
	    , #{refund_account} 
	    , #{refund_account_owner}
	    , #{refund_bank}
	)
	</insert>
	
	<select id="selectAddFileList" parameterType="hashmap" resultType="KE_EDU_OPER_ADD_FILE">
	SELECT 
		  ADD_FILE_NO
		, ORIG_FILE_NAME
		, CHANG_FILE_NAME
		, EXTENSION
		, FILE_SIZE
		, REGI_DATE 
	FROM  OPER_ADD_FILE 
	WHERE CODE_KIND + CODE_CERTIFI + CODE_SEQ + CODE_BRAN + BRAN_SEQ + RECEIPT_NO = #{operKey}
	</select>
	
	<update id="updateCodeOperation" parameterType="hashmap">
	UPDATE OPERATER SET 
		CODE_OPERATION = #{codeOperation}
	WHERE CODE_KIND + CODE_CERTIFI + CODE_SEQ + CODE_BRAN + BRAN_SEQ + RECEIPT_NO = #{operKey}
	</update>
	
	<!-- // 개인별 자격시험 신청 목록조회  -->
	<select id="selectExamOperatorRegList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	SELECT	
	 	  Row_number() OVER( ORDER BY C.oper_end_dt DESC, C.yyyy, C.code_kind) AS no
	 	, A.code_kind
	 	, A.code_certifi
	 	, A.code_seq
	 	, A.code_bran
	 	, A.bran_seq
	 	, A.receipt_no
	 	, CASE
	 	  WHEN ISNULL(C.SEASON, '') = ''  THEN 
	 		 ('제' + CONVERT(VARCHAR, C.OPERATION_CNT)+'회 ' + D.EDUTEST_NAME )
	 	  WHEN C.SEASON <= 2 THEN
		 	('제' + CONVERT(VARCHAR, C.OPERATION_CNT)+'회 ' + CONVERT(VARCHAR, C.SEASON) + '학기 ' + D.EDUTEST_NAME)
		  WHEN C.SEASON = 3 THEN
		      ('제' + CONVERT(VARCHAR, C.OPERATION_CNT)+'회 집합교육 ' + D.EDUTEST_NAME) 
		  WHEN C.SEASON = 4 THEN
		   	 ('제' + CONVERT(VARCHAR, C.OPERATION_CNT)+'회 온라인교육 ' + D.EDUTEST_NAME) 
		  END AS edutest_name   
       	, C.oper_start_dt
       	, A.oper_state
       	, dbo.Getcodevalue('022', A.oper_state)     AS oper_state_txt
       	, ISNULL(B.result_state, '')                AS result_state
       	, dbo.Getcodevalue('023', B.result_state)	AS result_state_txt 
       	, oper_name
       	, oper_lic_no
       	, oper_hp
       	, oper_email
	FROM  operater A 
   		LEFT JOIN OPER_RESULT B ON A.CODE_KIND = B.CODE_KIND AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ 
   			AND A.CODE_BRAN = B.CODE_BRAN AND A.BRAN_SEQ = B.BRAN_SEQ AND A.RECEIPT_NO = B.RECEIPT_NO 
  	 	INNER JOIN EDU_TEST C ON A.CODE_KIND = C.CODE_KIND AND A.CODE_CERTIFI = C.CODE_CERTIFI AND A.CODE_SEQ = C.CODE_SEQ 
   			AND A.CODE_BRAN = C.CODE_BRAN AND A.BRAN_SEQ = C.BRAN_SEQ 
   		INNER JOIN EDU_TEST_NAME D ON C.CODE_KIND = D.CODE_KIND AND C.CODE_CERTIFI = D.CODE_CERTIFI AND C.CODE_SEQ = D.CODE_SEQ 
	WHERE A.CODE_KIND = '5' 
		AND A.person_yn = #{codePers} 
	ORDER BY C.OPER_END_DT DESC, A.RECEIPT_NO DESC
	]]> 
	</select>
	
	
	<update id="updateExamCancel" parameterType="hashmap">
	UPDATE OPERATER SET 
			  OPER_HP =  #{oper_hp}
			, OPER_STATE= '09'
			, OPER_EMAIL = #{oper_email}
			, REFUND_ACCOUNT =  #{refund_account}
			, REFUND_ACCOUNT_OWNER = #{refund_account_owner}
			, REFUND_BANK = #{ refund_bank } 
	WHERE person_yn = #{codePers}
		AND CODE_KIND + CODE_CERTIFI + CODE_SEQ + CODE_BRAN + BRAN_SEQ + RECEIPT_NO = #{examKey}
	</update>
	
	<!-- // ======================================== 
		   [03]  자격증 관련 
		  ========================================  -->
	<!-- // 자격증 코드 목록조회 -->
	<select id="selectCertifiCodeList" parameterType="hashmap" resultType="hashmap">
	SELECT
	 	  code_certifi 
	 	, certifi_name
	FROM CERTIFI 
	WHERE code_certifi NOT IN ('0', '9')
	</select>
	
	<!-- // 최신 자격증 발급 정보 조회 -->
	<select id="selectMaxResultPrint" parameterType="hashmap" resultType="KE_EDU_CERTIFI">
 	SELECT 
 		  TOP(1)
 		  CODE_CERTIFI 
 		, RESULT_NO 
 		, CODE_SEQ 
 		, PRINT_STATE 
 		, 1 AS QUARTER 
 		, RESULT_START_DT 
 		, RESULT_END_DT
	FROM RESULT_PRINT
    WHERE CODE_PERS = #{codePers}
     	AND CODE_CERTIFI = #{codeCertifi}
		AND RESULT_DT = ( 
       			SELECT MAX(RESULT_DT) FROM RESULT_PRINT 
        		WHERE CODE_PERS = #{codePers} 
        			AND CODE_CERTIFI = #{codeCertifi} 
        			<if test="useYn != null">
        			<![CDATA[
        			AND PRINT_STATE <> '2'
        			]]>
        			</if>
        )	
    	<if test="useYn != null">
    	<![CDATA[
        AND (CONVERT(VARCHAR(8), GETDATE(), 112) >= RESULT_START_DT
        AND CONVERT(VARCHAR(8), GETDATE(), 112) <= RESULT_END_DT)
        AND PRINT_STATE <> '2' 
        ]]>
    	</if>
    ORDER BY RESULT_NO DESC            
	</select>
	
	<!-- // 합격한 시험목록 조회 (resultEndDt값이 존재할 경우 만료일이후 시험 조회) -->
	<select id="selectPassExamListByCertifi" parameterType="hashmap" resultType="KE_EDU_OPERATOR">
	SELECT
	      A.code_kind
	    , A.code_certifi
	    , A.code_seq
	    , A.code_bran
	    , A.bran_seq
	    , A.receipt_no
	    , A.code_operation
	    , C.season
	    , ( 	SELECT MAX(ADD_FILE_NO) FROM OPER_ADD_FILE D 
				WHERE A.CODE_KIND = D.CODE_KIND AND A.CODE_CERTIFI = D.CODE_CERTIFI AND A.CODE_SEQ = D.CODE_SEQ 
					AND A.CODE_BRAN = D.CODE_BRAN AND A.BRAN_SEQ = D.BRAN_SEQ AND A.RECEIPT_NO = D.RECEIPT_NO
		  ) AS add_file_no
	FROM OPERATER A
	LEFT JOIN OPER_RESULT B ON A.CODE_KIND = B.CODE_KIND AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ
    	AND A.CODE_BRAN = B.CODE_BRAN AND A.BRAN_SEQ = B.BRAN_SEQ AND A.RECEIPT_NO = B.RECEIPT_NO
	INNER JOIN EDU_TEST C ON A.CODE_KIND = C.CODE_KIND AND A.CODE_CERTIFI = C.CODE_CERTIFI AND A.CODE_SEQ = C.CODE_SEQ
    	AND A.CODE_BRAN = C.CODE_BRAN AND A.BRAN_SEQ = C.BRAN_SEQ
	WHERE A.CODE_KIND = '5'
		AND A.CODE_CERTIFI = #{codeCertifi}
		<![CDATA[ 
		AND A.OPER_STATE >= '10' 
		AND ISNULL(B.RESULT_STATE, '-1') >= '10'
		]]>
		<if test="resultEndDt != null">
		AND C.START_DT > #{resultEndDt}
		</if>
		
		<if test="seasonAry != null">
		AND C.SEASON IN
			<foreach collection="seasonAry" item="season"   open="(" close=")" separator=",">
      		 ${season}
  			</foreach>
		</if>
		AND A.PERSON_YN = #{codePers}
	ORDER BY C.OPER_START_DT DESC
	</select>
	
<!-- 	<select id="selectLastDuesList" parameterType="hashmap" resultType="hashmap">
	SELECT TOP(3) 
		  AUTH_START
		, AUTH_END
		, CONVERT(VARCHAR(8), DATEADD(D, -1, CONVERT(DATETIME, AUTH_START)), 112) AS PREV_AUTH_END 
	FROM DUES_H_TBL 
	WHERE CODE_PERS = #{codePers} 
		AND INCOM_FLAG = 'Y'
	ORDER BY DUES_H_SEQ DESC
	</select> -->
	
	<select id="selectLastDuesList" parameterType="hashmap" resultType="hashmap">
	select   AUTH_START
		, AUTH_END
		, CONVERT(VARCHAR(8), DATEADD(D, -1, CONVERT(DATETIME, AUTH_START)), 112) AS PREV_AUTH_END
	FROM DUES_H_TBL
	WHERE CODE_PERS = #{codePers} and  AUTH_END between DATEADD(YYYY, -3, CONVERT(DATETIME, GETDATE()))  and GETDATE()
	ORDER BY AUTH_END DESC
	</select>
	
	
	<select id="selectChgCerti" parameterType="hashmap" resultType="KE_EDU_CERTIFI">
	 SELECT TOP(1) RESULT_NO, CODE_SEQ, PRINT_STATE, 
        CASE 
        WHEN 
        	<![CDATA[ 
			SUBSTRING(CONVERT(VARCHAR(8), GETDATE(), 112), 1,4) = SUBSTRING(RESULT_END_DT, 1, 4) 
			AND SUBSTRING(RESULT_END_DT, 5, 4) >= '0801' 
			AND SUBSTRING(CONVERT(VARCHAR(8), GETDATE(), 112), 5,4) >= '0801'
			]]> 
        THEN 2 
        WHEN 
        	<![CDATA[ 
			SUBSTRING(CONVERT(VARCHAR(8), GETDATE(), 112), 1,4) = SUBSTRING(RESULT_END_DT, 1, 4) 
			AND SUBSTRING(RESULT_END_DT, 5, 4) <= '0731' 
			AND SUBSTRING(CONVERT(VARCHAR(8), GETDATE(), 112), 5,4) <= '0731'
			]]> 
        THEN 1 
        ELSE 0 
        END AS QUARTER 
	FROM RESULT_PRINT 
	WHERE  CODE_CERTIFI = #{codeCertifi}
		AND code_pers =  #{codePers}
		<![CDATA[ 
		AND (CONVERT(VARCHAR(8), GETDATE(), 112) >= RESULT_START_DT AND CONVERT(VARCHAR(8), GETDATE(), 112) <= RESULT_END_DT)
		]]>
	ORDER BY RESULT_END_DT DESC 
	</select>
	
	<select id="selectChgMarkCheckList" parameterType="hashmap" resultType="hashmap">
	SELECT 
		  C.outside_yn
		, D.edu_marks
		, ISNULL(D.SERVICE_MARKS, '0') AS service_marks
		, A.code_certifi
		, D.point_manage
	FROM OPERATER A 
	JOIN EDU_TEST B ON A.CODE_KIND = B.CODE_KIND 
		AND A.CODE_CERTIFI = B.CODE_CERTIFI AND A.CODE_SEQ = B.CODE_SEQ
		AND A.CODE_BRAN = B.CODE_BRAN AND A.BRAN_SEQ = B.BRAN_SEQ 
	JOIN EDU_TEST_NAME C ON B.CODE_KIND = C.CODE_KIND 
		AND B.CODE_CERTIFI = C.CODE_CERTIFI 
		AND B.CODE_SEQ = C.CODE_SEQ 
	JOIN OPER_RESULT D ON A.CODE_KIND = D.CODE_KIND 
		AND A.CODE_CERTIFI = D.CODE_CERTIFI 
		AND A.CODE_SEQ = D.CODE_SEQ 
		AND A.CODE_BRAN = D.CODE_BRAN 
		AND A.BRAN_SEQ = D.BRAN_SEQ 
		AND A.RECEIPT_NO = D.RECEIPT_NO 
	WHERE A.person_yn = #{codePers} 
		AND A.CODE_KIND = '2' 
		AND A.CODE_CERTIFI IN ('0', #{codeCertifi})
		 <![CDATA[ 
		AND (B.OPER_START_DT >= #{certStartDt} 
		AND B.OPER_END_DT <= #{certEndDt})
		]]> 
		AND D.POINT_MANAGE IN ('0', #{codeCertifi}) 
		AND D.RESULT_STATE >= '10'
	</select>
	
	<!-- // 갱신, 재교부 신청 -->
	<update id="updateResultPrint" parameterType="KE_EDU_CERTIFI">
	UPDATE RESULT_PRINT SET
		  PRINT_STATE = #{print_state}
		, ADD_FILE_2 = #{add_file_2}
		, ADD_FILE_5 = #{add_file_5}
		, REMITTOR = #{remittor}
		, DEPOSIT_DUE_DATE = #{deposit_due_date}
		, REISSUED_REASON = #{reissued_reason}
	WHERE code_pers = #{code_pers}
		AND code_certifi = #{code_certifi}
		AND result_no = #{result_no}
		AND code_seq = #{code_seq}
	</update>
	
	<insert id="insertOperAddFile" parameterType="KE_EDU_OPER_ADD_FILE">
	INSERT INTO OPER_ADD_FILE (
			  CODE_KIND
			, CODE_CERTIFI
			, CODE_SEQ
			, CODE_BRAN
			, BRAN_SEQ
			, RECEIPT_NO
			, ADD_FILE_NO
			, CHANG_FILE_NAME
			, EXTENSION
			, FILE_SIZE
			, REGI_DATE
	) VALUES (
			  #{code_kind}
			, #{code_certifi}
			, #{code_seq}
			, #{code_bran}
			, #{bran_seq}
			, #{receipt_no}
			, #{add_file_no}
			, #{chang_file_name}
			, #{extension}
			, #{file_size}
			, GETDATE()
	)
	</insert>
	
	<!-- // 교욱 개설 신청  -->
	<insert id="insertEduEstablishment"  parameterType="hashmap">
	<selectKey keyProperty="idx" order="BEFORE" resultType="int">
	SELECT 
		COUNT(idx) + 1
	FROM edu_establishment
	</selectKey>
	insert into edu_establishment (
		  idx
		, name 
		, birth
		, work_yy
		, work_mm
		, edu_type
		, edu_type_text
		, edu_area
		, lic_no
		, hp
		, email
		, big_name
		, company_name
		, regi_date
		, regi_time
	) values(
		   #{idx}					
		 , #{name}				
		 , #{pers_birth}		
		 , #{work_yy}				
		 , #{work_mm}				
		 , #{edu_type}			
		 , #{edu_type_text}		
		 , #{edu_area}
		 , #{lic_no}
		 , #{pers_hp}
		 , #{email}
		 , #{big_name}
		 , #{company_name}
		 , #{regi_date}			
		 , #{regi_time}			
	)
	</insert>
	
	<select id="selectReqResultPrintList" parameterType="hashmap" resultType="hashmap">
	SELECT
		  t.code_certifi
		, (SELECT CC.CERTIFI_NAME FROM CERTIFI CC WHERE CC.CODE_CERTIFI = b.CODE_CERTIFI) AS certifi_name  
	   	, ISNULL(t.season, 0) AS season
	 	, b.up_date
	FROM  edu_test t, operater a, oper_result b 
	WHERE t.code_kind + t.code_certifi + t.code_seq + t.code_bran + t.bran_seq 
			= a.code_kind + a.code_certifi + a.code_seq + a.code_bran + a.bran_seq
		AND a.code_kind + a.code_certifi + a.code_seq + a.code_bran + a.bran_seq + a.receipt_no	
			= b.code_kind + b.code_certifi + b.code_seq + b.code_bran + b.bran_seq + b.receipt_no
		AND a.person_yn = #{codePers}
		AND t.code_kind = '5' 
		AND result_state = '10'
		AND t.code_certifi NOT IN ('0', '9')
		AND ISNULL(result_no, '') = ''
	ORDER BY t.code_certifi, t.season
	</select>
	
	<!-- // ======================================== 
		   [05] 학술대회 
		  ========================================  -->	
	<select id="selectMeetingCount" parameterType="kda.work.education.data.KE_EDU_MEETING" resultType="int">
	SELECT 
		COUNT(IDX)
	FROM science_meeting_Active
	WHERE name = #{name}
		AND birth = #{birth}
	</select>
	
	<select id="selectMeetingIdx" resultType="string">
	SELECT idx FROM ( 
			SELECT Replace(CONVERT(varchar(255), NEWID()),'-','') AS idx
	) A
	</select>
	
	<insert id="insertMeeting" parameterType="kda.work.education.data.KE_EDU_MEETING">
	<choose>
		<when test='pay_flag == "C"'>
			INSERT INTO science_meeting_temp (	
		</when>
		<otherwise>
			INSERT INTO science_meeting_Active (
		</otherwise>
	</choose>
		  idx
		, name
		, birth
		, lic_no
		, member_flag
		, office_name
		, zip
		, addr
		, tel
		, tel_hp
		, email
		, lic_clinic_flag
		, lic_supply_flag
		, join_flag
		, pay_date
		, pay_amount
		, reg_date
		, pay_flag
		, diet_License01
		, diet_License02
		, diet_License03
		, diet_License04
		, branch_name
		, big_name
		, gtype
		, baccname
		, agree_yn
		, nice_agree_yn
		, nice_no
		, trainingName_no
		, online_yn
		, online_yn2
		, sect_name
		, ebook_yn
	) VALUES (
		  #{idx}
		, #{name}
		, #{birth}
		, #{lic_no}
		, #{member_flag}
		, #{office_name}
		, #{zip}
		, #{addr}
		, #{tel}
		, #{tel_hp}
		, #{email}
		, #{lic_clinic_flag}
		, #{lic_supply_flag}
		, #{join_flag}
		, #{pay_date}
		, #{pay_amount}
		, CONVERT(VARCHAR(8), GETDATE(), 112)
		, #{pay_flag}
		, #{diet_License01}
		, #{diet_License02}
		, #{diet_License03}
		, #{diet_License04}
		, #{branch_name}
		, #{big_name}
		, #{gtype}
		, #{baccname}
		, #{agree_yn}
		, #{nice_agree_yn}
		, #{nice_no}
		, #{trainingName_no}
		, #{online_yn}
		, #{online_yn2}
		, #{sect_name}
		, #{ebook_yn}
	)	
	</insert>
	
	<insert id="insertMeetingByTemp" parameterType="string">
	INSERT INTO  science_meeting_Active   
	SELECT * FROM science_meeting_temp  WHERE idx = #{idx}
	</insert>
	
	<insert id="insertMeetingDellist" parameterType="kda.work.education.data.KE_EDU_MEETING_DEL">
	INSERT INTO SCIENCE_MEETING_DELLIST ( 
		name, 
		office_name, 
		in_date, 
		in_paydate, 
		in_payprice, 
		bank_name, 
		bank_num, 
		bank_username, 
		lic_no,
		tel_hp,
		ipgum_bambup,
		del_date,
		del_price ,
		online_yn 
	) VALUES (
		#{name}, 
		#{office_name}, 
		#{in_date}, 
		#{in_paydate}, 
		#{in_payprice}, 
		#{bank_name}, 
		#{bank_num}, 
		#{bank_username}, 
		#{lic_no},
		#{tel_hp},
		#{ipgum_bambup},
		#{del_date},
		#{del_price},
		#{online_yn}
 	)
	</insert>
	
	<insert id="insertEduGreen" parameterType="kda.work.education.data.KE_EDU_GREEN">
	<selectKey keyProperty="idx" order="BEFORE" resultType="string">
	SELECT idx FROM ( 
			SELECT Replace(CONVERT(varchar(255), NEWID()),'-','') AS idx
	) A
	</selectKey>
	INSERT INTO edu_green ( 
		  idx
		, gubun
		, edu_type
		, edu_type_etc
		, name
		, pers_birth
		, pers_no_sub
		, email
		, email_sub
		, tel_hp
		, tel
		, branch_name
		, crtitle_name
		, name1
		, branch_name1
		, edu_js_type1
		, lic_no1
		, name2
		, branch_name2
		, edu_js_type2
		, lic_no2
		, file_flag
		, file_add
		, reg_date
		, up_date
		, is_open
	 ) VALUES ( 
 		  #{idx}
		, #{gubun}
		, #{edu_type}
		, #{edu_type_etc}
		, #{name}
		, #{pers_birth}
		, ''
		, #{email}
		, #{email_sub}
		, #{tel_hp}
		, #{tel}
		, #{branch_name}
		, #{crtitle_name}
		, #{name1}
		, #{branch_name1}
		, #{edu_js_type1}
		, #{lic_no1}
		, #{name2}
		, #{branch_name2}
		, #{edu_js_type2}
		, #{lic_no2}
		, #{file_flag}
		, #{file_add}
		, CONVERT(CHAR(19), CURRENT_TIMESTAMP, 120)
		, ''
		, 'N'
 	)
	</insert>
	
	<update id="updateEduGreen" parameterType="kda.work.education.data.KE_EDU_GREEN">
	UPDATE  edu_green SET
		  gubun = #{gubun}
		, edu_type = #{edu_type}
		, edu_type_etc = #{edu_type_etc}
		, name = #{name}
		, pers_birth = #{pers_birth}
		, pers_no_sub = ''
		, email = #{email}
		, email_sub = #{email_sub}
		, tel_hp = #{tel_hp}
		, tel = #{tel}
		, branch_name = #{branch_name}
		, crtitle_name = #{crtitle_name}
		, name1 = #{name1}
		, branch_name1 = #{branch_name1}
		, edu_js_type1 = #{edu_js_type1}
		, lic_no1 = #{lic_no1}
		, name2 = #{name2}
		, branch_name2 = #{branch_name2}
		, edu_js_type2 = #{edu_js_type2}
		, lic_no2 = #{lic_no2}
		, file_flag = #{file_flag}
		, file_add = #{file_add }
		, up_date =  CONVERT(CHAR(19), CURRENT_TIMESTAMP, 120)
		, is_open = 'N'
	 WHERE idx = #{idx}
	</update>
	
	<delete id="deleteEduGreen" parameterType="kda.work.education.data.KE_EDU_GREEN">
	DELETE FROM edu_green 
	WHERE idx = #{idx}
	</delete>
	
	<select id="selectGreenList" parameterType="hashmap" resultType="kda.work.education.data.KE_EDU_GREEN">
	SELECT
	      idx
		, name
	    , gubun
		, edu_type
		, edu_type_etc
		, reg_date
	FROM edu_green
	WHERE name = #{name}
		AND tel_hp = #{tel_hp}
	</select>
	
	<select id="selectGreen" parameterType="hashmap" resultType="kda.work.education.data.KE_EDU_GREEN">
	SELECT 
		*
	FROM edu_green
	WHERE idx = #{idx}
	</select>
	
	<select id="selectMeetingList" parameterType="hashmap" resultType="kda.work.education.data.KE_EDU_MEETING">
	SELECT
	      *
	FROM science_meeting_Active_ebook
	WHERE name = #{name}
		AND tel_hp = #{tel_hp}
		AND birth = #{birth}
	</select>
</mapper>

